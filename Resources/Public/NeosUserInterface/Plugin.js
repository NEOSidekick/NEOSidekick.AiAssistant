(()=>{var Ae=Object.create;var Z=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var Ce=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,Oe=Object.prototype.hasOwnProperty;var xe=(t,e)=>()=>(t&&(e=t(t=0)),e);var K=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var we=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ce(e))!Oe.call(t,r)&&r!==s&&Z(t,r,{get:()=>e[r],enumerable:!(n=re(e,r))||n.enumerable});return t};var k=(t,e,s)=>(s=t!=null?Ae(be(t)):{},we(e||!t||!t.__esModule?Z(s,"default",{value:t,enumerable:!0}):s,t));var H=(t,e,s,n)=>{for(var r=n>1?void 0:n?re(e,s):e,d=t.length-1,i;d>=0;d--)(i=t[d])&&(r=(n?i(e,s,r):i(r))||r);return n&&r&&Z(e,s,r),r};function N(t){return(...e)=>{if(window["@Neos:HostPluginAPI"]&&window["@Neos:HostPluginAPI"][`@${t}`])return window["@Neos:HostPluginAPI"][`@${t}`](...e);throw new Error("You are trying to read from a consumer api that hasn't been initialized yet!")}}var I=xe(()=>{});var $=K((et,ae)=>{I();ae.exports=N("NeosProjectPackages")().ReactUiComponents});var z=K((st,ce)=>{I();ce.exports=N("NeosProjectPackages")().NeosUiReduxStore});var G=K((ot,de)=>{I();de.exports=N("vendor")().React});var J=K((it,le)=>{I();le.exports=N("vendor")().reactRedux});var pe=K((ct,ue)=>{I();ue.exports=N("vendor")().reduxSagaEffects});var te=K((lt,me)=>{I();me.exports=N("vendor")().PropTypes});var se=K((pt,fe)=>{I();fe.exports=N("NeosProjectPackages")().NeosUiDecorators});I();var L=class{constructor(e){this.SERIAL_VERSION_UID="d8a5aa78-978e-11e6-ae22-56b6b6499611",this.description=e}};var Pe=(t,e="position",s="key")=>{let n=typeof e=="string"?o=>o[e]:e,r={},d={},i={},v={},u={},f={};t.forEach((o,g)=>{let p=o[s]?o[s]:String(g);r[p]=g;let C=n(o),y=String(C||g),_=!1;if(y.startsWith("start")){let c=y.match(/start\s+(\d+)/),a=c&&c[1]?Number(c[1]):0;i[a]||(i[a]=[]),i[a].push(p)}else if(y.startsWith("end")){let c=y.match(/end\s+(\d+)/),a=c&&c[1]?Number(c[1]):0;v[a]||(v[a]=[]),v[a].push(p)}else if(y.startsWith("before")){let c=y.match(/before\s+(\S+)(\s+(\d+))?/);if(!c)_=!0;else{let a=c[1],h=c[3]?Number(c[3]):0;u[a]||(u[a]={}),u[a][h]||(u[a][h]=[]),u[a][h].push(p)}}else if(y.startsWith("after")){let c=y.match(/after\s+(\S+)(\s+(\d+))?/);if(!c)_=!0;else{let a=c[1],h=c[3]?Number(c[3]):0;f[a]||(f[a]={}),f[a][h]||(f[a][h]=[]),f[a][h].push(p)}}else _=!0;if(_){let c=parseFloat(y);(isNaN(c)||!isFinite(c))&&(c=g),d[c]||(d[c]=[]),d[c].push(p)}});let l=[],S=[],x=[],A=[],m=(o,g)=>{let p=Object.keys(o).map(C=>Number(C)).sort((C,y)=>C-y);return g?p:p.reverse()},P=(o,g)=>{o.forEach(p=>{if(!(A.indexOf(p)>=0)){if(A.push(p),u[p]){let C=m(u[p],!0);for(let y of C)P(u[p][y],g)}if(g.push(p),f[p]){let C=m(f[p],!1);for(let y of C)P(f[p][y],g)}}})};for(let o of m(i,!1))P(i[o],l);for(let o of m(d,!0))P(d[o],S);for(let o of m(v,!0))P(v[o],x);for(let o of Object.keys(u))if(!(A.indexOf(o)>=0))for(let g of m(u[o],!1))P(u[o][g],l);for(let o of Object.keys(f))if(!(A.indexOf(o)>=0))for(let g of m(f[o],!1))P(f[o][g],S);return[...l,...S,...x].map(o=>r[o]).map(o=>t[o])},ee=Pe;var F=class extends L{constructor(e){super(e),this._registry=[]}set(e,s,n=0){if(typeof e!="string")throw new Error("Key must be a string");if(typeof n!="string"&&typeof n!="number")throw new Error("Position must be a string or a number");let r={key:e,value:s};n&&(r.position=n);let d=this._registry.findIndex(i=>i.key===e);return d===-1?this._registry.push(r):this._registry[d]=r,s}get(e){if(typeof e!="string")return console.error("Key must be a string"),null;let s=this._registry.find(n=>n.key===e);return s?s.value:null}_getChildrenWrapped(e){let s=this._registry.filter(n=>n.key.indexOf(e+"/")===0);return ee(s)}getChildrenAsObject(e){let s={};return this._getChildrenWrapped(e).forEach(n=>{s[n.key]=n.value}),s}getChildren(e){return this._getChildrenWrapped(e).map(s=>s.value)}has(e){return typeof e!="string"?(console.error("Key must be a string"),!1):!!this._registry.find(s=>s.key===e)}_getAllWrapped(){return ee(this._registry)}getAllAsObject(){let e={};return this._getAllWrapped().forEach(s=>{e[s.key]=s.value}),e}getAllAsList(){return this._getAllWrapped().map(e=>Object.assign({id:e.key},e.value))}};var ie=N("manifest");var U=k($()),W=k(z()),w=k(G()),oe=k(J()),ke=k(pe());var E=k(G()),ge=k(J()),b=k(te()),he=k(se()),B=k($()),V=k(z());var De={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},R=class extends E.PureComponent{constructor(s){super(s);this.state={loading:!1};this.getIcon=s=>s?E.default.createElement(B.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):E.default.createElement(B.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async s=>{let{commit:n,externalService:r,contentService:d,activeContentDimensions:i,addFlashMessage:v,i18nRegistry:u}=this.props;this.setState({loading:!0});let f=d.getCurrentDocumentNode()?.properties?.title,l=d.getGuestFrameDocumentHtml();try{let S=await r.generate(s,i.language?i.language[0]:"",f,l);n(S)}catch(S){console.error(S),v("NEOSidekick.AiAssistant",u.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})}}render(){let{id:s,value:n,className:r,commit:d,options:i,i18nRegistry:v,onKeyPress:u,onEnterKey:f}=this.props,l=Object.assign({},De,i),S=i&&i.placeholder&&v.translate(unescape(i.placeholder)),x=!(l.readonly||l.disabled);return E.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},E.default.createElement("div",null,E.default.createElement(B.TextInput,{id:s,value:n,onChange:d,disabled:l.disabled||this.state.loading,maxLength:l.maxlength,readOnly:l.readonly,placeholder:S,onKeyPress:u,onEnterKey:f})),x?E.default.createElement("div",null,E.default.createElement(B.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(l.module)},v.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};R.propTypes={className:b.default.string,value:b.default.oneOfType([b.default.string,b.default.number]),commit:b.default.func.isRequired,options:b.default.object,onKeyPress:b.default.func,onEnterKey:b.default.func,id:b.default.string,activeContentDimensions:b.default.object.isRequired,i18nRegistry:b.default.object.isRequired,externalService:b.default.object.isRequired,contentService:b.default.object.isRequired,addFlashMessage:b.default.func.isRequired},R.defaultProps={options:{}},R=H([(0,he.neos)(t=>({i18nRegistry:t.get("i18n"),externalService:t.get("NEOSidekick.AiAssistant").get("externalService"),contentService:t.get("NEOSidekick.AiAssistant").get("contentService")})),(0,ge.connect)(t=>({activeContentDimensions:V.selectors.CR.ContentDimensions.active(t)}),{addFlashMessage:V.actions.UI.FlashMessages.add})],R);var D=k(G()),ye=k(J()),O=k(te()),Se=k(se()),T=k($()),Y=k(z());var _e={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},j=class extends D.Component{constructor(s){super(s);this.getIcon=s=>s?D.default.createElement(T.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):D.default.createElement(T.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async s=>{let{commit:n,externalService:r,contentService:d,activeContentDimensions:i,addFlashMessage:v,i18nRegistry:u}=this.props;this.setState({loading:!0});let f=d.getCurrentDocumentNode()?.properties?.title,l=d.getGuestFrameDocumentHtml();try{let S=await r.generate(s,i.language?i.language[0]:"",f,l);n(S)}catch(S){console.error(S),v("NEOSidekick.AiAssistant",u.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})};this.state={loading:!1}}render(){let{id:s,value:n,className:r,commit:d,options:i,i18nRegistry:v,onKeyPress:u,onEnterKey:f}=this.props,l=Object.assign({},_e,i),S=i&&i.placeholder&&v.translate(unescape(i.placeholder)),x=!(l.readonly||l.disabled);return D.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},D.default.createElement("div",null,D.default.createElement(T.TextArea,{id:s,value:n,onChange:d,disabled:l.disabled||this.state.loading,maxLength:l.maxlength,readOnly:l.readonly,placeholder:S,minRows:l.minRows,expandedRows:l.expandedRows,onKeyPress:u,onEnterKey:f})),x?D.default.createElement("div",null,D.default.createElement(T.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(l.module)},v.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};j.propTypes={className:O.default.string,value:O.default.oneOfType([O.default.string,O.default.number]),commit:O.default.func.isRequired,options:O.default.object,onKeyPress:O.default.func,onEnterKey:O.default.func,id:O.default.string,activeContentDimensions:O.default.object.isRequired,i18nRegistry:O.default.object.isRequired,externalService:O.default.object.isRequired,contentService:O.default.object.isRequired,addFlashMessage:O.default.func.isRequired},j.defaultProps={options:{}},j=H([(0,Se.neos)(t=>({i18nRegistry:t.get("i18n"),externalService:t.get("NEOSidekick.AiAssistant").get("externalService"),contentService:t.get("NEOSidekick.AiAssistant").get("contentService")})),(0,ye.connect)(t=>({activeContentDimensions:Y.selectors.CR.ContentDimensions.active(t)}),{addFlashMessage:Y.actions.UI.FlashMessages.add})],j);var q=class{constructor(e,s){this.apiDomain="";this.apiKey="";this.generate=async(e,s,n,r)=>(await(await fetch(`${this.apiDomain}/api/v1/chat?language=${s}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"application/json"},body:JSON.stringify({module:"meta_description",platform:"neos",user_input:[{identifier:"title",value:n},{identifier:"content",value:r}]})})).json())?.data?.message?.message;this.apiDomain=e,this.apiKey=s}};var ve=(t,e)=>new ne(t,e),ne=class{constructor(t,e){this.getGuestFrameDocumentHtml=()=>document.getElementsByName("neos-content-main")[0]?.contentDocument?.body?.innerHTML;this.getCurrentDocumentNode=()=>{let t=this.store.getState(),e=t?.cr?.nodes?.documentNode;return t?.cr?.nodes?.byContextPath[e]};this.getCurrentDocumentNodeType=()=>{let t=this.getCurrentDocumentNode();return this.globalRegistry.get("@neos-project/neos-ui-contentrepository").get(t?.nodeType)};this.getCurrentDocumentPageBriefing=()=>{let node=this.getCurrentDocumentNode(),template=this.getCurrentDocumentNodeType().options.sidekick.pageBriefing.replaceAll("`","\\`");return console.log(node,template),eval("`"+template+"`")};this.globalRegistry=t,this.store=e}};function Ne(t){return new Promise(e=>setTimeout(e,t))}ie("NEOSidekick.AiAssistant",{},(t,{store:e,frontendConfiguration:s})=>{let n=s["NEOSidekick.AiAssistant"];if(n===null||n.enabled===!1)return;t.set("NEOSidekick.AiAssistant",new F("test")),t.get("NEOSidekick.AiAssistant").set("externalService",new q(n.apiDomain,n.apiKey)),t.get("NEOSidekick.AiAssistant").set("contentService",ve(t,e));let r=t.get("containers"),d=r.get("App"),i=x=>{let A=localStorage.getItem("NEOSidekick")?JSON.parse(localStorage.getItem("NEOSidekick")):{open:!0,fullscreen:!1},[m,P]=w.default.useState(A?.open),M=h=>{P(h),A.open=h,localStorage.setItem("NEOSidekick",JSON.stringify(A))},[o,g]=w.default.useState(A?.fullscreen),p=h=>{g(h),A.fullscreen=h,localStorage.setItem("NEOSidekick",JSON.stringify(A))},C=(h,Q,X)=>{if(h)return w.default.createElement(U.IconButton,{icon:Q?"compress":"expand",onClick:X})},y=(h,Q,X)=>{if(!Q)return w.default.createElement(U.IconButton,{icon:h?"chevron-circle-right":"chevron-circle-left",onClick:X})},_=(0,oe.useSelector)(W.selectors.CR.ContentDimensions.active),c=(0,oe.useSelector)(h=>h?.user?.preferences?.interfaceLanguage),a=new URL(`${n.apiDomain}/chat/`);return a.searchParams.append("contentLanguage",_.language?_.language[0]:""),a.searchParams.append("interfaceLanguage",c),a.searchParams.append("userId",n.userId),a.searchParams.append("plattform","neos"),a.searchParams.append("domain",n.domain),a.searchParams.append("siteName",n.siteName),n?.referral&&a.searchParams.append("referral",n?.referral),n?.apiKey&&a.searchParams.append("apikey",n?.apiKey),w.default.createElement("div",{className:`neosidekick_appWrapper ${m?"neosidekick_appWrapper--sidebar-open":""}  ${o?"neosidekick_appWrapper--sidebar-fullscreen":""}`},w.default.createElement(d,{...x}),w.default.createElement("div",{className:"neosidekick_sideBar"},w.default.createElement("div",{className:"neosidekick_sideBar__title"},w.default.createElement(U.Headline,{className:`neosidekick_sideBar__title-headline ${m?"neosidekick_sideBar__title-headline--open":""}`},"AI Sidekick"),w.default.createElement("div",null,C(m,o,()=>p(!o)),y(m,o,()=>M(!m)))),w.default.createElement("iframe",{id:"neosidekickAssistant",className:`neosidekick_sideBar__frame ${m?"neosidekick_sideBar__frame--open":""}`,src:a.toString(),allow:"clipboard-write",onLoad:h=>h.target.dataset.loaded=!0})))};r.set("App",i);let v=x=>{let A=setInterval(()=>{let m=document.getElementById("neosidekickAssistant");if(m.dataset.hasOwnProperty("loaded"))console.log("loaded, sending message to frame",x),m.contentWindow.postMessage(x,"*"),clearInterval(A);else{console.log("not loaded, waiting...");return}},250)},u=!1,f=function*(){yield(0,ke.takeLatest)([W.actionTypes.UI.ContentCanvas.SET_SRC,W.actionTypes.UI.ContentCanvas.RELOAD,W.actionTypes.CR.Nodes.MERGE],function*(x){x.type===W.actionTypes.UI.ContentCanvas.SET_SRC&&(u=!0),yield Ne(500);let A=t.get("@neos-project/neos-ui-contentrepository"),m=e.getState(),M=document.getElementsByName("neos-content-main")[0]?.contentDocument,o=m?.ui?.contentCanvas?.previewUrl,g=m?.cr?.nodes?.documentNode,p=Object.values(m?.cr?.nodes?.byContextPath||{}).filter(C=>{let y=A.getRole("document");if(!y)throw new Error("Document role is not loaded!");let _=A.getSubTypesOf(y);return g&&C.contextPath.indexOf(g.split("@")[0])===0&&(C.contextPath===g||!_.includes(C.nodeType))});v({version:"1.0",eventName:u?"page-changed":"page-updated",data:{url:o,title:m?.cr?.nodes?.byContextPath[g]?.properties?.title||M?.title,content:M?.body?.innerHTML,structuredContent:p}}),u=!1})};t.get("sagas").set("NEOSidekick.AiAssistant/watchDocumentNodeChange",{saga:f});let S=t.get("inspector").get("editors");S.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextFieldEditor",{component:R}),S.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextAreaEditor",{component:j}),console.log(t)});})();
//# sourceMappingURL=Plugin.js.map
