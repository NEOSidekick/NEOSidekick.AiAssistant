(()=>{var xe=Object.create;var te=Object.defineProperty;var ce=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var Ee=Object.getPrototypeOf,De=Object.prototype.hasOwnProperty;var Pe=(n,e)=>()=>(n&&(e=n(n=0)),e);var W=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var _e=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Oe(e))!De.call(n,r)&&r!==t&&te(n,r,{get:()=>e[r],enumerable:!(s=ce(e,r))||s.enumerable});return n};var v=(n,e,t)=>(t=n!=null?xe(Ee(n)):{},_e(e||!n||!n.__esModule?te(t,"default",{value:n,enumerable:!0}):t,n));var z=(n,e,t,s)=>{for(var r=s>1?void 0:s?ce(e,t):e,o=n.length-1,i;o>=0;o--)(i=n[o])&&(r=(s?i(e,t,r):i(r))||r);return s&&r&&te(e,t,r),r};function k(n){return(...e)=>{if(window["@Neos:HostPluginAPI"]&&window["@Neos:HostPluginAPI"][`@${n}`])return window["@Neos:HostPluginAPI"][`@${n}`](...e);throw new Error("You are trying to read from a consumer api that hasn't been initialized yet!")}}var I=Pe(()=>{});var G=W((rt,le)=>{I();le.exports=k("NeosProjectPackages")().ReactUiComponents});var J=W((it,ue)=>{I();ue.exports=k("NeosProjectPackages")().NeosUiReduxStore});var V=W((ct,pe)=>{I();pe.exports=k("vendor")().React});var Y=W((lt,me)=>{I();me.exports=k("vendor")().reactRedux});var fe=W((pt,ge)=>{I();ge.exports=k("vendor")().reduxSagaEffects});var se=W((gt,he)=>{I();he.exports=k("vendor")().PropTypes});var re=W((ht,ye)=>{I();ye.exports=k("NeosProjectPackages")().NeosUiDecorators});I();var H=class{constructor(e){this.SERIAL_VERSION_UID="d8a5aa78-978e-11e6-ae22-56b6b6499611",this.description=e}};var Ie=(n,e="position",t="key")=>{let s=typeof e=="string"?a=>a[e]:e,r={},o={},i={},S={},m={},g={};n.forEach((a,y)=>{let l=a[t]?a[t]:String(y);r[l]=y;let N=s(a),f=String(N||y),R=!1;if(f.startsWith("start")){let c=f.match(/start\s+(\d+)/),u=c&&c[1]?Number(c[1]):0;i[u]||(i[u]=[]),i[u].push(l)}else if(f.startsWith("end")){let c=f.match(/end\s+(\d+)/),u=c&&c[1]?Number(c[1]):0;S[u]||(S[u]=[]),S[u].push(l)}else if(f.startsWith("before")){let c=f.match(/before\s+(\S+)(\s+(\d+))?/);if(!c)R=!0;else{let u=c[1],E=c[3]?Number(c[3]):0;m[u]||(m[u]={}),m[u][E]||(m[u][E]=[]),m[u][E].push(l)}}else if(f.startsWith("after")){let c=f.match(/after\s+(\S+)(\s+(\d+))?/);if(!c)R=!0;else{let u=c[1],E=c[3]?Number(c[3]):0;g[u]||(g[u]={}),g[u][E]||(g[u][E]=[]),g[u][E].push(l)}}else R=!0;if(R){let c=parseFloat(f);(isNaN(c)||!isFinite(c))&&(c=y),o[c]||(o[c]=[]),o[c].push(l)}});let d=[],p=[],T=[],B=[],w=(a,y)=>{let l=Object.keys(a).map(N=>Number(N)).sort((N,f)=>N-f);return y?l:l.reverse()},h=(a,y)=>{a.forEach(l=>{if(!(B.indexOf(l)>=0)){if(B.push(l),m[l]){let N=w(m[l],!0);for(let f of N)h(m[l][f],y)}if(y.push(l),g[l]){let N=w(g[l],!1);for(let f of N)h(g[l][f],y)}}})};for(let a of w(i,!1))h(i[a],d);for(let a of w(o,!0))h(o[a],p);for(let a of w(S,!0))h(S[a],T);for(let a of Object.keys(m))if(!(B.indexOf(a)>=0))for(let y of w(m[a],!1))h(m[a][y],d);for(let a of Object.keys(g))if(!(B.indexOf(a)>=0))for(let y of w(g[a],!1))h(g[a][y],p);return[...d,...p,...T].map(a=>r[a]).map(a=>n[a])},ne=Ie;var j=class extends H{constructor(e){super(e),this._registry=[]}set(e,t,s=0){if(typeof e!="string")throw new Error("Key must be a string");if(typeof s!="string"&&typeof s!="number")throw new Error("Position must be a string or a number");let r={key:e,value:t};s&&(r.position=s);let o=this._registry.findIndex(i=>i.key===e);return o===-1?this._registry.push(r):this._registry[o]=r,t}get(e){if(typeof e!="string")return console.error("Key must be a string"),null;let t=this._registry.find(s=>s.key===e);return t?t.value:null}_getChildrenWrapped(e){let t=this._registry.filter(s=>s.key.indexOf(e+"/")===0);return ne(t)}getChildrenAsObject(e){let t={};return this._getChildrenWrapped(e).forEach(s=>{t[s.key]=s.value}),t}getChildren(e){return this._getChildrenWrapped(e).map(t=>t.value)}has(e){return typeof e!="string"?(console.error("Key must be a string"),!1):!!this._registry.find(t=>t.key===e)}_getAllWrapped(){return ne(this._registry)}getAllAsObject(){let e={};return this._getAllWrapped().forEach(t=>{e[t.key]=t.value}),e}getAllAsList(){return this._getAllWrapped().map(e=>Object.assign({id:e.key},e.value))}};var de=k("manifest");var $=v(G()),U=v(J()),O=v(V()),ae=v(Y()),we=v(fe());var D=v(V()),Se=v(Y()),A=v(se()),ve=v(re()),M=v(G()),Q=v(J());var Ke={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},F=class extends D.Component{constructor(t){super(t);this.state={loading:!1};this.getIcon=t=>t?D.default.createElement(M.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):D.default.createElement(M.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async t=>{let{commit:s,externalService:r,contentService:o,activeContentDimensions:i,addFlashMessage:S,i18nRegistry:m}=this.props;this.setState({loading:!0});let g=o.getCurrentDocumentNode()?.properties?.title,d=o.getGuestFrameDocumentHtml();try{let p=await r.generate(t,i.language?i.language[0]:"",g,d);s(p)}catch(p){console.error(p),S("NEOSidekick.AiAssistant",m.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})}}render(){let{id:t,value:s,className:r,commit:o,options:i,i18nRegistry:S,onKeyPress:m,onEnterKey:g}=this.props,d=Object.assign({},Ke,i),p=i&&i.placeholder&&S.translate(unescape(i.placeholder)),T=!(d.readonly||d.disabled);return D.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},D.default.createElement("div",null,D.default.createElement(M.TextInput,{id:t,value:s,onChange:o,disabled:d.disabled||this.state.loading,maxLength:d.maxlength,readOnly:d.readonly,placeholder:p,onKeyPress:m,onEnterKey:g})),T?D.default.createElement("div",null,D.default.createElement(M.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(d.module)},S.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};F.propTypes={className:A.default.string,value:A.default.oneOfType([A.default.string,A.default.number]),commit:A.default.func.isRequired,options:A.default.object,onKeyPress:A.default.func,onEnterKey:A.default.func,id:A.default.string,activeContentDimensions:A.default.object.isRequired,i18nRegistry:A.default.object.isRequired,externalService:A.default.object.isRequired,contentService:A.default.object.isRequired,addFlashMessage:A.default.func.isRequired},F.defaultProps={options:{}},F=z([(0,ve.neos)(n=>({i18nRegistry:n.get("i18n"),externalService:n.get("NEOSidekick.AiAssistant").get("externalService"),contentService:n.get("NEOSidekick.AiAssistant").get("contentService")})),(0,Se.connect)(n=>({activeContentDimensions:Q.selectors.CR.ContentDimensions.active(n)}),{addFlashMessage:Q.actions.UI.FlashMessages.add})],F);var P=v(V()),ke=v(Y()),C=v(se()),Ne=v(re()),L=v(G()),X=v(J());var Re={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},K=class extends P.Component{constructor(t){super(t);this.getIcon=t=>t?P.default.createElement(L.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):P.default.createElement(L.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async t=>{let{commit:s,externalService:r,contentService:o,activeContentDimensions:i,addFlashMessage:S,i18nRegistry:m}=this.props;this.setState({loading:!0});let g=o.getCurrentDocumentNode()?.properties?.title,d=o.getGuestFrameDocumentHtml();try{let p=await r.generate(t,i.language?i.language[0]:"",g,d);s(p)}catch(p){console.error(p),S(p?.code??p?.message,p?.code?m.translate("NEOSidekick.AiAssistant:Error:"+p.code):p?.message,p?.severity??"error")}this.setState({loading:!1})};this.state={loading:!1}}render(){let{id:t,value:s,className:r,commit:o,options:i,i18nRegistry:S,onKeyPress:m,onEnterKey:g}=this.props,d=Object.assign({},Re,i),p=i&&i.placeholder&&S.translate(unescape(i.placeholder)),T=!(d.readonly||d.disabled);return P.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},P.default.createElement("div",null,P.default.createElement(L.TextArea,{id:t,value:s,onChange:o,disabled:d.disabled||this.state.loading,maxLength:d.maxlength,readOnly:d.readonly,placeholder:p,minRows:d.minRows,expandedRows:d.expandedRows,onKeyPress:m,onEnterKey:g})),T?P.default.createElement("div",null,P.default.createElement(L.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(d.module)},S.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};K.propTypes={className:C.default.string,value:C.default.oneOfType([C.default.string,C.default.number]),commit:C.default.func.isRequired,options:C.default.object,onKeyPress:C.default.func,onEnterKey:C.default.func,id:C.default.string,activeContentDimensions:C.default.object.isRequired,i18nRegistry:C.default.object.isRequired,externalService:C.default.object.isRequired,contentService:C.default.object.isRequired,addFlashMessage:C.default.func.isRequired},K.defaultProps={options:{}},K=z([(0,Ne.neos)(n=>({i18nRegistry:n.get("i18n"),externalService:n.get("NEOSidekick.AiAssistant").get("externalService"),contentService:n.get("NEOSidekick.AiAssistant").get("contentService")})),(0,ke.connect)(n=>({activeContentDimensions:X.selectors.CR.ContentDimensions.active(n)}),{addFlashMessage:X.actions.UI.FlashMessages.add})],K);var q=class extends Error{constructor(t,s){super(t);this.severity="error";this.code=s}};var Ae=n=>{let e=n["NEOSidekick.AiAssistant"];return new oe(e.apiDomain,e.apiKey)},oe=class{constructor(e,t){this.apiDomain="";this.apiKey="";this.generate=async(e,t,s,r)=>{if(!this.apiKey)throw new q("This feature is not available in the free version.","1688157373215");let o=await fetch(`${this.apiDomain}/api/v1/chat?language=${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"application/json"},body:JSON.stringify({module:"meta_description",platform:"neos",user_input:[{identifier:"title",value:s},{identifier:"content",value:r}]})});if(o.status===401)throw new q("The AISidekick api key provided is not valid.","1688158193038");if(o.status<200||o.status>=400)throw new q("An error occurred while asking AISidekick.","1688158257149");return(await o.json())?.data?.message?.message};this.apiDomain=e,this.apiKey=t}};var Ce=(n,e)=>new ie(n,e),ie=class{constructor(e,t){this.getGuestFrameDocumentHtml=()=>document.getElementsByName("neos-content-main")[0]?.contentDocument?.body?.innerHTML;this.getCurrentDocumentNode=()=>{let e=this.store.getState(),t=e?.cr?.nodes?.documentNode;return e?.cr?.nodes?.byContextPath[t]};this.getCurrentDocumentNodeType=()=>{let e=this.getCurrentDocumentNode();return this.globalRegistry.get("@neos-project/neos-ui-contentrepository").get(e?.nodeType)};this.getCurrentDocumentTargetAudience=()=>{let e=this.getCurrentDocumentNode(),t=this.getCurrentDocumentNodeType()?.options?.sidekick?.targetAudience;return t?this.processClientEval(t,e,e):null};this.getCurrentDocumentPageBriefing=()=>{let e=this.getCurrentDocumentNode(),t=this.getCurrentDocumentNodeType()?.options?.sidekick?.pageBriefing;return t?this.processClientEval(t,e,e):null};this.getCurrentDocumentFocusKeyword=()=>{let e=this.getCurrentDocumentNode(),t=this.getCurrentDocumentNodeType()?.options?.sidekick?.focusKeyword;return t?this.processClientEval(t,e,e):null};this.processClientEval=(e,t,s)=>{if(typeof e=="string"&&e.startsWith("ClientEval:"))try{return new Function("node,parentNode","return "+e.replace("ClientEval:",""))(t,s)}catch(r){console.warn('An error occurred while trying to evaluate "'+e+`"
`,r)}return e};this.globalRegistry=e,this.store=t}};function be(n){return new Promise(e=>setTimeout(e,n))}de("NEOSidekick.AiAssistant",{},(n,{store:e,frontendConfiguration:t})=>{let s=t["NEOSidekick.AiAssistant"];if(s===null||s.enabled===!1)return;n.set("NEOSidekick.AiAssistant",new j("test"));let r=Ae(t);n.get("NEOSidekick.AiAssistant").set("externalService",r);let o=Ce(n,e);n.get("NEOSidekick.AiAssistant").set("contentService",o);let i=n.get("containers"),S=i.get("App"),m=w=>{let h=localStorage.getItem("NEOSidekick")?JSON.parse(localStorage.getItem("NEOSidekick")):{open:!0,fullscreen:!1},[b,a]=O.default.useState(h?.open),y=x=>{a(x),h.open=x,localStorage.setItem("NEOSidekick",JSON.stringify(h))},[l,N]=O.default.useState(h?.fullscreen),f=x=>{N(x),h.fullscreen=x,localStorage.setItem("NEOSidekick",JSON.stringify(h))},R=(x,Z,ee)=>{if(x)return O.default.createElement($.IconButton,{icon:Z?"compress":"expand",onClick:ee})},c=(x,Z,ee)=>{if(!Z)return O.default.createElement($.IconButton,{icon:x?"chevron-circle-right":"chevron-circle-left",onClick:ee})},u=(0,ae.useSelector)(U.selectors.CR.ContentDimensions.active),E=(0,ae.useSelector)(x=>x?.user?.preferences?.interfaceLanguage),_=new URL(`${s.apiDomain}/chat/`);return _.searchParams.append("contentLanguage",u.language?u.language[0]:""),_.searchParams.append("interfaceLanguage",E),_.searchParams.append("userId",s.userId),_.searchParams.append("plattform","neos"),_.searchParams.append("domain",s.domain),_.searchParams.append("siteName",s.siteName),s?.referral&&_.searchParams.append("referral",s?.referral),s?.apiKey&&_.searchParams.append("apikey",s?.apiKey),O.default.createElement("div",{className:`neosidekick_appWrapper ${b?"neosidekick_appWrapper--sidebar-open":""}  ${l?"neosidekick_appWrapper--sidebar-fullscreen":""}`},O.default.createElement(S,{...w}),O.default.createElement("div",{className:"neosidekick_sideBar"},O.default.createElement("div",{className:"neosidekick_sideBar__title"},O.default.createElement($.Headline,{className:`neosidekick_sideBar__title-headline ${b?"neosidekick_sideBar__title-headline--open":""}`},"AI Sidekick"),O.default.createElement("div",null,R(b,l,()=>f(!l)),c(b,l,()=>y(!b)))),O.default.createElement("iframe",{id:"neosidekickAssistant",className:`neosidekick_sideBar__frame ${b?"neosidekick_sideBar__frame--open":""}`,src:_.toString(),allow:"clipboard-write",onLoad:x=>x.target.dataset.loaded=!0})))};i.set("App",m);let g=w=>{let h=setInterval(()=>{let b=document.getElementById("neosidekickAssistant");if(b.dataset.hasOwnProperty("loaded"))console.log("loaded, sending message to frame",w),b.contentWindow.postMessage(w,"*"),clearInterval(h);else{console.log("not loaded, waiting...");return}},250)},d=!1,p=function*(){yield(0,we.takeLatest)([U.actionTypes.UI.ContentCanvas.SET_SRC,U.actionTypes.UI.ContentCanvas.RELOAD,U.actionTypes.CR.Nodes.MERGE],function*(w){w.type===U.actionTypes.UI.ContentCanvas.SET_SRC&&(d=!0),yield be(500);let h=n.get("@neos-project/neos-ui-contentrepository"),b=e.getState(),y=document.getElementsByName("neos-content-main")[0]?.contentDocument,l=b?.ui?.contentCanvas?.previewUrl,N=o.getCurrentDocumentNode(),f=N?.contextPath,R=Object.values(b?.cr?.nodes?.byContextPath||{}).filter(c=>{let u=h.getRole("document");if(!u)throw new Error("Document role is not loaded!");let E=h.getSubTypesOf(u);return f&&c.contextPath.indexOf(f.split("@")[0])===0&&(c.contextPath===f||!E.includes(c.nodeType))});g({version:"1.0",eventName:d?"page-changed":"page-updated",data:{url:l,title:N?.properties?.title||y?.title,content:y?.body?.innerHTML,structuredContent:R,targetAudience:o.getCurrentDocumentTargetAudience(),pageBriefing:o.getCurrentDocumentPageBriefing(),focusKeyword:o.getCurrentDocumentFocusKeyword()}}),d=!1})};n.get("sagas").set("NEOSidekick.AiAssistant/watchDocumentNodeChange",{saga:p});let B=n.get("inspector").get("editors");B.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextFieldEditor",{component:F}),B.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextAreaEditor",{component:K})});})();
//# sourceMappingURL=Plugin.js.map
