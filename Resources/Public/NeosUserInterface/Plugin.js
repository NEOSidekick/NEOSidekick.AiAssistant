(()=>{var Ae=Object.create;var ee=Object.defineProperty;var ie=Object.getOwnPropertyDescriptor;var Oe=Object.getOwnPropertyNames;var be=Object.getPrototypeOf,we=Object.prototype.hasOwnProperty;var xe=(n,e)=>()=>(n&&(e=n(n=0)),e);var T=(n,e)=>()=>(e||n((e={exports:{}}).exports,e),e.exports);var De=(n,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Oe(e))!we.call(n,r)&&r!==t&&ee(n,r,{get:()=>e[r],enumerable:!(s=ie(e,r))||s.enumerable});return n};var N=(n,e,t)=>(t=n!=null?Ae(be(n)):{},De(e||!n||!n.__esModule?ee(t,"default",{value:n,enumerable:!0}):t,n));var $=(n,e,t,s)=>{for(var r=s>1?void 0:s?ie(e,t):e,c=n.length-1,i;c>=0;c--)(i=n[c])&&(r=(s?i(e,t,r):i(r))||r);return s&&r&&ee(e,t,r),r};function k(n){return(...e)=>{if(window["@Neos:HostPluginAPI"]&&window["@Neos:HostPluginAPI"][`@${n}`])return window["@Neos:HostPluginAPI"][`@${n}`](...e);throw new Error("You are trying to read from a consumer api that hasn't been initialized yet!")}}var I=xe(()=>{});var z=T((tt,ce)=>{I();ce.exports=k("NeosProjectPackages")().ReactUiComponents});var G=T((st,de)=>{I();de.exports=k("NeosProjectPackages")().NeosUiReduxStore});var J=T((ot,ue)=>{I();ue.exports=k("vendor")().React});var V=T((at,le)=>{I();le.exports=k("vendor")().reactRedux});var me=T((dt,pe)=>{I();pe.exports=k("vendor")().reduxSagaEffects});var ne=T((lt,fe)=>{I();fe.exports=k("vendor")().PropTypes});var se=T((mt,ge)=>{I();ge.exports=k("NeosProjectPackages")().NeosUiDecorators});I();var L=class{constructor(e){this.SERIAL_VERSION_UID="d8a5aa78-978e-11e6-ae22-56b6b6499611",this.description=e}};var Ee=(n,e="position",t="key")=>{let s=typeof e=="string"?o=>o[e]:e,r={},c={},i={},S={},m={},l={};n.forEach((o,f)=>{let u=o[t]?o[t]:String(f);r[u]=f;let A=s(o),y=String(A||f),E=!1;if(y.startsWith("start")){let a=y.match(/start\s+(\d+)/),p=a&&a[1]?Number(a[1]):0;i[p]||(i[p]=[]),i[p].push(u)}else if(y.startsWith("end")){let a=y.match(/end\s+(\d+)/),p=a&&a[1]?Number(a[1]):0;S[p]||(S[p]=[]),S[p].push(u)}else if(y.startsWith("before")){let a=y.match(/before\s+(\S+)(\s+(\d+))?/);if(!a)E=!0;else{let p=a[1],v=a[3]?Number(a[3]):0;m[p]||(m[p]={}),m[p][v]||(m[p][v]=[]),m[p][v].push(u)}}else if(y.startsWith("after")){let a=y.match(/after\s+(\S+)(\s+(\d+))?/);if(!a)E=!0;else{let p=a[1],v=a[3]?Number(a[3]):0;l[p]||(l[p]={}),l[p][v]||(l[p][v]=[]),l[p][v].push(u)}}else E=!0;if(E){let a=parseFloat(y);(isNaN(a)||!isFinite(a))&&(a=f),c[a]||(c[a]=[]),c[a].push(u)}});let d=[],C=[],F=[],D=[],h=(o,f)=>{let u=Object.keys(o).map(A=>Number(A)).sort((A,y)=>A-y);return f?u:u.reverse()},g=(o,f)=>{o.forEach(u=>{if(!(D.indexOf(u)>=0)){if(D.push(u),m[u]){let A=h(m[u],!0);for(let y of A)g(m[u][y],f)}if(f.push(u),l[u]){let A=h(l[u],!1);for(let y of A)g(l[u][y],f)}}})};for(let o of h(i,!1))g(i[o],d);for(let o of h(c,!0))g(c[o],C);for(let o of h(S,!0))g(S[o],F);for(let o of Object.keys(m))if(!(D.indexOf(o)>=0))for(let f of h(m[o],!1))g(m[o][f],d);for(let o of Object.keys(l))if(!(D.indexOf(o)>=0))for(let f of h(l[o],!1))g(l[o][f],C);return[...d,...C,...F].map(o=>r[o]).map(o=>n[o])},te=Ee;var j=class extends L{constructor(e){super(e),this._registry=[]}set(e,t,s=0){if(typeof e!="string")throw new Error("Key must be a string");if(typeof s!="string"&&typeof s!="number")throw new Error("Position must be a string or a number");let r={key:e,value:t};s&&(r.position=s);let c=this._registry.findIndex(i=>i.key===e);return c===-1?this._registry.push(r):this._registry[c]=r,t}get(e){if(typeof e!="string")return console.error("Key must be a string"),null;let t=this._registry.find(s=>s.key===e);return t?t.value:null}_getChildrenWrapped(e){let t=this._registry.filter(s=>s.key.indexOf(e+"/")===0);return te(t)}getChildrenAsObject(e){let t={};return this._getChildrenWrapped(e).forEach(s=>{t[s.key]=s.value}),t}getChildren(e){return this._getChildrenWrapped(e).map(t=>t.value)}has(e){return typeof e!="string"?(console.error("Key must be a string"),!1):!!this._registry.find(t=>t.key===e)}_getAllWrapped(){return te(this._registry)}getAllAsObject(){let e={};return this._getAllWrapped().forEach(t=>{e[t.key]=t.value}),e}getAllAsList(){return this._getAllWrapped().map(e=>Object.assign({id:e.key},e.value))}};var ae=k("manifest");var U=N(z()),M=N(G()),x=N(J()),oe=N(V()),ke=N(me());var P=N(J()),he=N(V()),O=N(ne()),ye=N(se()),B=N(z()),Y=N(G());var _e={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},R=class extends P.PureComponent{constructor(t){super(t);this.state={loading:!1};this.getIcon=t=>t?P.default.createElement(B.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):P.default.createElement(B.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async t=>{let{commit:s,externalService:r,contentService:c,activeContentDimensions:i,addFlashMessage:S,i18nRegistry:m}=this.props;this.setState({loading:!0});let l=c.getCurrentDocumentNode()?.properties?.title,d=c.getGuestFrameDocumentHtml();try{let C=await r.generate(t,i.language?i.language[0]:"",l,d);s(C)}catch(C){console.error(C),S("NEOSidekick.AiAssistant",m.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})}}render(){let{id:t,value:s,className:r,commit:c,options:i,i18nRegistry:S,onKeyPress:m,onEnterKey:l}=this.props,d=Object.assign({},_e,i),C=i&&i.placeholder&&S.translate(unescape(i.placeholder)),F=!(d.readonly||d.disabled);return P.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},P.default.createElement("div",null,P.default.createElement(B.TextInput,{id:t,value:s,onChange:c,disabled:d.disabled||this.state.loading,maxLength:d.maxlength,readOnly:d.readonly,placeholder:C,onKeyPress:m,onEnterKey:l})),F?P.default.createElement("div",null,P.default.createElement(B.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(d.module)},S.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};R.propTypes={className:O.default.string,value:O.default.oneOfType([O.default.string,O.default.number]),commit:O.default.func.isRequired,options:O.default.object,onKeyPress:O.default.func,onEnterKey:O.default.func,id:O.default.string,activeContentDimensions:O.default.object.isRequired,i18nRegistry:O.default.object.isRequired,externalService:O.default.object.isRequired,contentService:O.default.object.isRequired,addFlashMessage:O.default.func.isRequired},R.defaultProps={options:{}},R=$([(0,ye.neos)(n=>({i18nRegistry:n.get("i18n"),externalService:n.get("NEOSidekick.AiAssistant").get("externalService"),contentService:n.get("NEOSidekick.AiAssistant").get("contentService")})),(0,he.connect)(n=>({activeContentDimensions:Y.selectors.CR.ContentDimensions.active(n)}),{addFlashMessage:Y.actions.UI.FlashMessages.add})],R);var _=N(J()),Se=N(V()),b=N(ne()),ve=N(se()),W=N(z()),Q=N(G());var Fe={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},K=class extends _.Component{constructor(t){super(t);this.getIcon=t=>t?_.default.createElement(W.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):_.default.createElement(W.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async t=>{let{commit:s,externalService:r,contentService:c,activeContentDimensions:i,addFlashMessage:S,i18nRegistry:m}=this.props;this.setState({loading:!0});let l=c.getCurrentDocumentNode()?.properties?.title,d=c.getGuestFrameDocumentHtml();try{let C=await r.generate(t,i.language?i.language[0]:"",l,d);s(C)}catch(C){console.error(C),S("NEOSidekick.AiAssistant",m.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})};this.state={loading:!1}}render(){let{id:t,value:s,className:r,commit:c,options:i,i18nRegistry:S,onKeyPress:m,onEnterKey:l}=this.props,d=Object.assign({},Fe,i),C=i&&i.placeholder&&S.translate(unescape(i.placeholder)),F=!(d.readonly||d.disabled);return _.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},_.default.createElement("div",null,_.default.createElement(W.TextArea,{id:t,value:s,onChange:c,disabled:d.disabled||this.state.loading,maxLength:d.maxlength,readOnly:d.readonly,placeholder:C,minRows:d.minRows,expandedRows:d.expandedRows,onKeyPress:m,onEnterKey:l})),F?_.default.createElement("div",null,_.default.createElement(W.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(d.module)},S.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};K.propTypes={className:b.default.string,value:b.default.oneOfType([b.default.string,b.default.number]),commit:b.default.func.isRequired,options:b.default.object,onKeyPress:b.default.func,onEnterKey:b.default.func,id:b.default.string,activeContentDimensions:b.default.object.isRequired,i18nRegistry:b.default.object.isRequired,externalService:b.default.object.isRequired,contentService:b.default.object.isRequired,addFlashMessage:b.default.func.isRequired},K.defaultProps={options:{}},K=$([(0,ve.neos)(n=>({i18nRegistry:n.get("i18n"),externalService:n.get("NEOSidekick.AiAssistant").get("externalService"),contentService:n.get("NEOSidekick.AiAssistant").get("contentService")})),(0,Se.connect)(n=>({activeContentDimensions:Q.selectors.CR.ContentDimensions.active(n)}),{addFlashMessage:Q.actions.UI.FlashMessages.add})],K);var q=class{constructor(e,t){this.apiDomain="";this.apiKey="";this.generate=async(e,t,s,r)=>(await(await fetch(`${this.apiDomain}/api/v1/chat?language=${t}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"application/json"},body:JSON.stringify({module:"meta_description",platform:"neos",user_input:[{identifier:"title",value:s},{identifier:"content",value:r}]})})).json())?.data?.message?.message;this.apiDomain=e,this.apiKey=t}};var Ne=(n,e)=>new re(n,e),re=class{constructor(e,t){this.getGuestFrameDocumentHtml=()=>document.getElementsByName("neos-content-main")[0]?.contentDocument?.body?.innerHTML;this.getCurrentDocumentNode=()=>{let e=this.store.getState(),t=e?.cr?.nodes?.documentNode;return e?.cr?.nodes?.byContextPath[t]};this.getCurrentDocumentNodeType=()=>{let e=this.getCurrentDocumentNode();return this.globalRegistry.get("@neos-project/neos-ui-contentrepository").get(e?.nodeType)};this.getCurrentDocumentTargetAudience=()=>{let e=this.getCurrentDocumentNode(),t=this.getCurrentDocumentNodeType()?.options?.sidekick?.targetAudience;return t?this.processClientEval(t,e,e):null};this.getCurrentDocumentPageBriefing=()=>{let e=this.getCurrentDocumentNode(),t=this.getCurrentDocumentNodeType()?.options?.sidekick?.pageBriefing;return t?this.processClientEval(t,e,e):null};this.getCurrentDocumentFocusKeyword=()=>{let e=this.getCurrentDocumentNode(),t=this.getCurrentDocumentNodeType()?.options?.sidekick?.focusKeyword;return t?this.processClientEval(t,e,e):null};this.processClientEval=(e,t,s)=>{if(typeof e=="string"&&e.startsWith("ClientEval:"))try{return new Function("node,parentNode","return "+e.replace("ClientEval:",""))(t,s)}catch(r){console.warn('An error occurred while trying to evaluate "'+e+`"
`,r)}return e};this.globalRegistry=e,this.store=t}};function Ce(n){return new Promise(e=>setTimeout(e,n))}ae("NEOSidekick.AiAssistant",{},(n,{store:e,frontendConfiguration:t})=>{let s=t["NEOSidekick.AiAssistant"];if(s===null||s.enabled===!1)return;n.set("NEOSidekick.AiAssistant",new j("test")),n.get("NEOSidekick.AiAssistant").set("externalService",new q(s.apiDomain,s.apiKey));let r=Ne(n,e);n.get("NEOSidekick.AiAssistant").set("contentService",r);let c=n.get("containers"),i=c.get("App"),S=D=>{let h=localStorage.getItem("NEOSidekick")?JSON.parse(localStorage.getItem("NEOSidekick")):{open:!0,fullscreen:!1},[g,H]=x.default.useState(h?.open),o=w=>{H(w),h.open=w,localStorage.setItem("NEOSidekick",JSON.stringify(h))},[f,u]=x.default.useState(h?.fullscreen),A=w=>{u(w),h.fullscreen=w,localStorage.setItem("NEOSidekick",JSON.stringify(h))},y=(w,X,Z)=>{if(w)return x.default.createElement(U.IconButton,{icon:X?"compress":"expand",onClick:Z})},E=(w,X,Z)=>{if(!X)return x.default.createElement(U.IconButton,{icon:w?"chevron-circle-right":"chevron-circle-left",onClick:Z})},a=(0,oe.useSelector)(M.selectors.CR.ContentDimensions.active),p=(0,oe.useSelector)(w=>w?.user?.preferences?.interfaceLanguage),v=new URL(`${s.apiDomain}/chat/`);return v.searchParams.append("contentLanguage",a.language?a.language[0]:""),v.searchParams.append("interfaceLanguage",p),v.searchParams.append("userId",s.userId),v.searchParams.append("plattform","neos"),v.searchParams.append("domain",s.domain),v.searchParams.append("siteName",s.siteName),s?.referral&&v.searchParams.append("referral",s?.referral),s?.apiKey&&v.searchParams.append("apikey",s?.apiKey),x.default.createElement("div",{className:`neosidekick_appWrapper ${g?"neosidekick_appWrapper--sidebar-open":""}  ${f?"neosidekick_appWrapper--sidebar-fullscreen":""}`},x.default.createElement(i,{...D}),x.default.createElement("div",{className:"neosidekick_sideBar"},x.default.createElement("div",{className:"neosidekick_sideBar__title"},x.default.createElement(U.Headline,{className:`neosidekick_sideBar__title-headline ${g?"neosidekick_sideBar__title-headline--open":""}`},"AI Sidekick"),x.default.createElement("div",null,y(g,f,()=>A(!f)),E(g,f,()=>o(!g)))),x.default.createElement("iframe",{id:"neosidekickAssistant",className:`neosidekick_sideBar__frame ${g?"neosidekick_sideBar__frame--open":""}`,src:v.toString(),allow:"clipboard-write",onLoad:w=>w.target.dataset.loaded=!0})))};c.set("App",S);let m=D=>{let h=setInterval(()=>{let g=document.getElementById("neosidekickAssistant");if(g.dataset.hasOwnProperty("loaded"))console.log("loaded, sending message to frame",D),g.contentWindow.postMessage(D,"*"),clearInterval(h);else{console.log("not loaded, waiting...");return}},250)},l=!1,d=function*(){yield(0,ke.takeLatest)([M.actionTypes.UI.ContentCanvas.SET_SRC,M.actionTypes.UI.ContentCanvas.RELOAD,M.actionTypes.CR.Nodes.MERGE],function*(D){D.type===M.actionTypes.UI.ContentCanvas.SET_SRC&&(l=!0),yield Ce(500);let h=n.get("@neos-project/neos-ui-contentrepository"),g=e.getState(),o=document.getElementsByName("neos-content-main")[0]?.contentDocument,f=g?.ui?.contentCanvas?.previewUrl,u=r.getCurrentDocumentNode(),A=u?.contextPath,y=Object.values(g?.cr?.nodes?.byContextPath||{}).filter(E=>{let a=h.getRole("document");if(!a)throw new Error("Document role is not loaded!");let p=h.getSubTypesOf(a);return A&&E.contextPath.indexOf(A.split("@")[0])===0&&(E.contextPath===A||!p.includes(E.nodeType))});m({version:"1.0",eventName:l?"page-changed":"page-updated",data:{url:f,title:u?.properties?.title||o?.title,content:o?.body?.innerHTML,structuredContent:y,targetAudience:r.getCurrentDocumentTargetAudience(),pageBriefing:r.getCurrentDocumentPageBriefing(),focusKeyword:r.getCurrentDocumentFocusKeyword()}}),l=!1})};n.get("sagas").set("NEOSidekick.AiAssistant/watchDocumentNodeChange",{saga:d});let F=n.get("inspector").get("editors");F.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextFieldEditor",{component:R}),F.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextAreaEditor",{component:K})});})();
//# sourceMappingURL=Plugin.js.map
