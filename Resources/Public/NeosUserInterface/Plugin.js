(()=>{var ke=Object.create;var ee=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var Ae=Object.getOwnPropertyNames;var Ce=Object.getPrototypeOf,xe=Object.prototype.hasOwnProperty;var Pe=(t,e)=>()=>(t&&(e=t(t=0)),e);var B=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var Oe=(t,e,s,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of Ae(e))!xe.call(t,r)&&r!==s&&ee(t,r,{get:()=>e[r],enumerable:!(n=re(e,r))||n.enumerable});return t};var k=(t,e,s)=>(s=t!=null?ke(Ce(t)):{},Oe(e||!t||!t.__esModule?ee(s,"default",{value:t,enumerable:!0}):s,t));var G=(t,e,s,n)=>{for(var r=n>1?void 0:n?re(e,s):e,p=t.length-1,a;p>=0;p--)(a=t[p])&&(r=(n?a(e,s,r):a(r))||r);return n&&r&&ee(e,s,r),r};function A(t){return(...e)=>{if(window["@Neos:HostPluginAPI"]&&window["@Neos:HostPluginAPI"][`@${t}`])return window["@Neos:HostPluginAPI"][`@${t}`](...e);throw new Error("You are trying to read from a consumer api that hasn't been initialized yet!")}}var I=Pe(()=>{});var J=B((Ze,ae)=>{I();ae.exports=A("NeosProjectPackages")().ReactUiComponents});var V=B((tt,ce)=>{I();ce.exports=A("NeosProjectPackages")().NeosUiReduxStore});var Y=B((nt,de)=>{I();de.exports=A("vendor")().React});var Q=B((rt,le)=>{I();le.exports=A("vendor")().reactRedux});var pe=B((at,ue)=>{I();ue.exports=A("vendor")().reduxSagaEffects});var se=B((dt,me)=>{I();me.exports=A("vendor")().PropTypes});var ne=B((ut,fe)=>{I();fe.exports=A("NeosProjectPackages")().NeosUiDecorators});I();var U=class{constructor(e){this.SERIAL_VERSION_UID="d8a5aa78-978e-11e6-ae22-56b6b6499611",this.description=e}};var be=(t,e="position",s="key")=>{let n=typeof e=="string"?o=>o[e]:e,r={},p={},a={},v={},d={},g={};t.forEach((o,h)=>{let m=o[s]?o[s]:String(h);r[m]=h;let P=n(o),S=String(P||h),_=!1;if(S.startsWith("start")){let c=S.match(/start\s+(\d+)/),i=c&&c[1]?Number(c[1]):0;a[i]||(a[i]=[]),a[i].push(m)}else if(S.startsWith("end")){let c=S.match(/end\s+(\d+)/),i=c&&c[1]?Number(c[1]):0;v[i]||(v[i]=[]),v[i].push(m)}else if(S.startsWith("before")){let c=S.match(/before\s+(\S+)(\s+(\d+))?/);if(!c)_=!0;else{let i=c[1],y=c[3]?Number(c[3]):0;d[i]||(d[i]={}),d[i][y]||(d[i][y]=[]),d[i][y].push(m)}}else if(S.startsWith("after")){let c=S.match(/after\s+(\S+)(\s+(\d+))?/);if(!c)_=!0;else{let i=c[1],y=c[3]?Number(c[3]):0;g[i]||(g[i]={}),g[i][y]||(g[i][y]=[]),g[i][y].push(m)}}else _=!0;if(_){let c=parseFloat(S);(isNaN(c)||!isFinite(c))&&(c=h),p[c]||(p[c]=[]),p[c].push(m)}});let l=[],O=[],N=[],u=[],f=(o,h)=>{let m=Object.keys(o).map(P=>Number(P)).sort((P,S)=>P-S);return h?m:m.reverse()},w=(o,h)=>{o.forEach(m=>{if(!(u.indexOf(m)>=0)){if(u.push(m),d[m]){let P=f(d[m],!0);for(let S of P)w(d[m][S],h)}if(h.push(m),g[m]){let P=f(g[m],!1);for(let S of P)w(g[m][S],h)}}})};for(let o of f(a,!1))w(a[o],l);for(let o of f(p,!0))w(p[o],O);for(let o of f(v,!0))w(v[o],N);for(let o of Object.keys(d))if(!(u.indexOf(o)>=0))for(let h of f(d[o],!1))w(d[o][h],l);for(let o of Object.keys(g))if(!(u.indexOf(o)>=0))for(let h of f(g[o],!1))w(g[o][h],O);return[...l,...O,...N].map(o=>r[o]).map(o=>t[o])},te=be;var F=class extends U{constructor(e){super(e),this._registry=[]}set(e,s,n=0){if(typeof e!="string")throw new Error("Key must be a string");if(typeof n!="string"&&typeof n!="number")throw new Error("Position must be a string or a number");let r={key:e,value:s};n&&(r.position=n);let p=this._registry.findIndex(a=>a.key===e);return p===-1?this._registry.push(r):this._registry[p]=r,s}get(e){if(typeof e!="string")return console.error("Key must be a string"),null;let s=this._registry.find(n=>n.key===e);return s?s.value:null}_getChildrenWrapped(e){let s=this._registry.filter(n=>n.key.indexOf(e+"/")===0);return te(s)}getChildrenAsObject(e){let s={};return this._getChildrenWrapped(e).forEach(n=>{s[n.key]=n.value}),s}getChildren(e){return this._getChildrenWrapped(e).map(s=>s.value)}has(e){return typeof e!="string"?(console.error("Key must be a string"),!1):!!this._registry.find(s=>s.key===e)}_getAllWrapped(){return te(this._registry)}getAllAsObject(){let e={};return this._getAllWrapped().forEach(s=>{e[s.key]=s.value}),e}getAllAsList(){return this._getAllWrapped().map(e=>Object.assign({id:e.key},e.value))}};var ie=A("manifest");var z=k(J()),T=k(V()),b=k(Y()),oe=k(Q()),ve=k(pe());var E=k(Y()),ge=k(Q()),C=k(se()),he=k(ne()),K=k(J()),L=k(V());var Ee={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},R=class extends E.PureComponent{constructor(s){super(s);this.state={loading:!1};this.getIcon=s=>s?E.default.createElement(K.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):E.default.createElement(K.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async s=>{let{commit:n,externalService:r,contentService:p,nodesByContextPath:a,currentDocumentNodePath:v,activeContentDimensions:d,addFlashMessage:g,i18nRegistry:l}=this.props;this.setState({loading:!0});let O=a[v]?.properties?.title,N=p.getGuestFrameDocumentHtml();try{let u=await r.generate(s,d.language?d.language[0]:"",O,N);n(u)}catch(u){console.error(u),g("NEOSidekick.AiAssistant",l.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})}}render(){let{id:s,value:n,className:r,commit:p,options:a,i18nRegistry:v,onKeyPress:d,onEnterKey:g}=this.props,l=Object.assign({},Ee,a),O=a&&a.placeholder&&v.translate(unescape(a.placeholder)),N=!(l.readonly||l.disabled);return E.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},E.default.createElement("div",null,E.default.createElement(K.TextInput,{id:s,value:n,onChange:p,disabled:l.disabled||this.state.loading,maxLength:l.maxlength,readOnly:l.readonly,placeholder:O,onKeyPress:d,onEnterKey:g})),N?E.default.createElement("div",null,E.default.createElement(K.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(l.module)},v.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};R.propTypes={className:C.default.string,value:C.default.oneOfType([C.default.string,C.default.number]),commit:C.default.func.isRequired,options:C.default.object,onKeyPress:C.default.func,onEnterKey:C.default.func,id:C.default.string,nodesByContextPath:C.default.object,currentDocumentNodePath:C.default.string,activeContentDimensions:C.default.object.isRequired,i18nRegistry:C.default.object.isRequired,externalService:C.default.object.isRequired,contentService:C.default.object.isRequired,addFlashMessage:C.default.func.isRequired},R.defaultProps={options:{}},R=G([(0,he.neos)(t=>({i18nRegistry:t.get("i18n"),externalService:t.get("NEOSidekick.AiAssistant").get("externalService"),contentService:t.get("NEOSidekick.AiAssistant").get("contentService")})),(0,ge.connect)(t=>({nodesByContextPath:L.selectors.CR.Nodes.nodesByContextPathSelector(t),currentDocumentNodePath:L.selectors.CR.Nodes.documentNodeContextPathSelector(t),activeContentDimensions:L.selectors.CR.ContentDimensions.active(t)}),{addFlashMessage:L.actions.UI.FlashMessages.add})],R);var D=k(Y()),ye=k(Q()),x=k(se()),Se=k(ne()),W=k(J()),M=k(V());var De={autoFocus:!1,disabled:!1,maxlength:null,readonly:!1},j=class extends D.Component{constructor(s){super(s);this.getIcon=s=>s?D.default.createElement(W.Icon,{icon:"spinner",size:"",fixedWidth:!0,padded:"right",spin:!0}):D.default.createElement(W.Icon,{icon:"magic",size:"",fixedWidth:!0,padded:"right"});this.fetch=async s=>{let{commit:n,externalService:r,contentService:p,nodesByContextPath:a,currentDocumentNodePath:v,activeContentDimensions:d,addFlashMessage:g,i18nRegistry:l}=this.props;this.setState({loading:!0});let O=a[v]?.properties?.title,N=p.getGuestFrameDocumentHtml();try{let u=await r.generate(s,d.language?d.language[0]:"",O,N);n(u)}catch(u){console.error(u),g("NEOSidekick.AiAssistant",l.translate("NEOSidekick.AiAssistant:Main:failedToGenerate"),"ERROR")}this.setState({loading:!1})};this.state={loading:!1}}render(){let{id:s,value:n,className:r,commit:p,options:a,i18nRegistry:v,onKeyPress:d,onEnterKey:g}=this.props,l=Object.assign({},De,a),O=a&&a.placeholder&&v.translate(unescape(a.placeholder)),N=!(l.readonly||l.disabled);return D.default.createElement("div",{style:{display:"flex",flexDirection:"column"},className:r},D.default.createElement("div",null,D.default.createElement(W.TextArea,{id:s,value:n,onChange:p,disabled:l.disabled||this.state.loading,maxLength:l.maxlength,readOnly:l.readonly,placeholder:O,minRows:l.minRows,expandedRows:l.expandedRows,onKeyPress:d,onEnterKey:g})),N?D.default.createElement("div",null,D.default.createElement(W.Button,{className:"generateBtn",size:"regular",icon:this.state.loading?"hourglass":"magic",style:"neutral",hoverStyle:"clean",disabled:this.state.loading,onClick:async()=>await this.fetch(l.module)},v.translate("NEOSidekick.AiAssistant:Main:generate"),"\xA0",this.getIcon(this.state.loading))):null)}};j.propTypes={className:x.default.string,value:x.default.oneOfType([x.default.string,x.default.number]),commit:x.default.func.isRequired,options:x.default.object,onKeyPress:x.default.func,onEnterKey:x.default.func,id:x.default.string,nodesByContextPath:x.default.object,currentDocumentNodePath:x.default.string,activeContentDimensions:x.default.object.isRequired,i18nRegistry:x.default.object.isRequired,externalService:x.default.object.isRequired,contentService:x.default.object.isRequired,addFlashMessage:x.default.func.isRequired},j.defaultProps={options:{}},j=G([(0,Se.neos)(t=>({i18nRegistry:t.get("i18n"),externalService:t.get("NEOSidekick.AiAssistant").get("externalService"),contentService:t.get("NEOSidekick.AiAssistant").get("contentService")})),(0,ye.connect)(t=>({nodesByContextPath:M.selectors.CR.Nodes.nodesByContextPathSelector(t),currentDocumentNodePath:M.selectors.CR.Nodes.documentNodeContextPathSelector(t),activeContentDimensions:M.selectors.CR.ContentDimensions.active(t)}),{addFlashMessage:M.actions.UI.FlashMessages.add})],j);var H=class{constructor(e,s){this.apiDomain="";this.apiKey="";this.generate=async(e,s,n,r)=>(await(await fetch(`${this.apiDomain}/api/v1/chat?language=${s}`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${this.apiKey}`,Accept:"application/json"},body:JSON.stringify({module:"meta_description",platform:"neos",user_input:[{identifier:"title",value:n},{identifier:"content",value:r}]})})).json())?.data?.message?.message;this.apiDomain=e,this.apiKey=s}};var $=class{constructor(){this.getGuestFrameDocumentHtml=()=>document.getElementsByName("neos-content-main")[0]?.contentDocument?.body?.innerHTML}};function Ne(t){return new Promise(e=>setTimeout(e,t))}ie("NEOSidekick.AiAssistant",{},(t,{store:e,frontendConfiguration:s})=>{let n=s["NEOSidekick.AiAssistant"];if(n===null||n.enabled===!1)return;let r=t.get("containers"),p=r.get("App"),a=N=>{let u=localStorage.getItem("NEOSidekick")?JSON.parse(localStorage.getItem("NEOSidekick")):{open:!0,fullscreen:!1},[f,w]=b.default.useState(u?.open),q=y=>{w(y),u.open=y,localStorage.setItem("NEOSidekick",JSON.stringify(u))},[o,h]=b.default.useState(u?.fullscreen),m=y=>{h(y),u.fullscreen=y,localStorage.setItem("NEOSidekick",JSON.stringify(u))},P=(y,X,Z)=>{if(y)return b.default.createElement(z.IconButton,{icon:X?"compress":"expand",onClick:Z})},S=(y,X,Z)=>{if(!X)return b.default.createElement(z.IconButton,{icon:y?"chevron-circle-right":"chevron-circle-left",onClick:Z})},_=(0,oe.useSelector)(T.selectors.CR.ContentDimensions.active),c=(0,oe.useSelector)(y=>y?.user?.preferences?.interfaceLanguage),i=new URL(`${n.apiDomain}/chat/`);return i.searchParams.append("contentLanguage",_.language?_.language[0]:""),i.searchParams.append("interfaceLanguage",c),i.searchParams.append("userId",n.userId),i.searchParams.append("plattform","neos"),i.searchParams.append("domain",n.domain),i.searchParams.append("siteName",n.siteName),n?.referral&&i.searchParams.append("referral",n?.referral),n?.apiKey&&i.searchParams.append("apikey",n?.apiKey),b.default.createElement("div",{className:`neosidekick_appWrapper ${f?"neosidekick_appWrapper--sidebar-open":""}  ${o?"neosidekick_appWrapper--sidebar-fullscreen":""}`},b.default.createElement(p,{...N}),b.default.createElement("div",{className:"neosidekick_sideBar"},b.default.createElement("div",{className:"neosidekick_sideBar__title"},b.default.createElement(z.Headline,{className:`neosidekick_sideBar__title-headline ${f?"neosidekick_sideBar__title-headline--open":""}`},"AI Sidekick"),b.default.createElement("div",null,P(f,o,()=>m(!o)),S(f,o,()=>q(!f)))),b.default.createElement("iframe",{id:"neosidekickAssistant",className:`neosidekick_sideBar__frame ${f?"neosidekick_sideBar__frame--open":""}`,src:i.toString(),allow:"clipboard-write",onLoad:y=>y.target.dataset.loaded=!0})))};r.set("App",a);let v=N=>{let u=setInterval(()=>{let f=document.getElementById("neosidekickAssistant");if(f.dataset.hasOwnProperty("loaded"))console.log("loaded, sending message to frame",N),f.contentWindow.postMessage(N,"*"),clearInterval(u);else{console.log("not loaded, waiting...");return}},250)},d=!1,g=function*(){yield(0,ve.takeLatest)([T.actionTypes.UI.ContentCanvas.SET_SRC,T.actionTypes.UI.ContentCanvas.RELOAD,T.actionTypes.CR.Nodes.MERGE],function*(N){N.type===T.actionTypes.UI.ContentCanvas.SET_SRC&&(d=!0),yield Ne(500);let u=t.get("@neos-project/neos-ui-contentrepository"),f=e.getState(),q=document.getElementsByName("neos-content-main")[0]?.contentDocument,o=f?.ui?.contentCanvas?.previewUrl,h=f?.cr?.nodes?.documentNode,m=Object.values(f?.cr?.nodes?.byContextPath||{}).filter(P=>{let S=u.getRole("document");if(!S)throw new Error("Document role is not loaded!");let _=u.getSubTypesOf(S);return h&&P.contextPath.indexOf(h.split("@")[0])===0&&(P.contextPath===h||!_.includes(P.nodeType))});v({version:"1.0",eventName:d?"page-changed":"page-updated",data:{url:o,title:f?.cr?.nodes?.byContextPath[h]?.properties?.title||q?.title,content:q?.body?.innerHTML,structuredContent:m}}),d=!1})};t.get("sagas").set("NEOSidekick.AiAssistant/watchDocumentNodeChange",{saga:g});let O=t.get("inspector").get("editors");O.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextFieldEditor",{component:R}),O.set("NEOSidekick.AiAssistant/Inspector/Editors/MagicTextAreaEditor",{component:j}),t.set("NEOSidekick.AiAssistant",new F("test")),t.get("NEOSidekick.AiAssistant").set("externalService",new H(n.apiDomain,n.apiKey)),t.get("NEOSidekick.AiAssistant").set("contentService",new $),console.log(t)});})();
//# sourceMappingURL=Plugin.js.map
